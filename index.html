<style>
:root{
  --pink:#ff7eb9;
  --aqua:#7dd3fc;
  --gold:#ffd166;
  --outline:rgba(255,255,255,0.35);
}

/* RESET */
*{margin:0;padding:0;box-sizing:border-box;}
html,body{
  height:100%;
  width:100%;
  overflow:hidden;
}
body{
  display:flex;
  align-items:center;
  justify-content:center;
  background:radial-gradient(circle at top,#1f2937 0%,#020617 55%,#000 100%);
  font-family:'Noto Sans JP',system-ui,sans-serif;
  color:#f9fafb;
}

/* PHONE SHELL ‚Äì responsive size */
.shell{
  position:relative;
  padding:18px 22px 24px;
  border-radius:24px;
  background:radial-gradient(circle at top,rgba(148,163,255,0.25),rgba(15,23,42,0.98));
  border:1px solid rgba(148,163,255,0.5);
  display:flex;
  flex-direction:column;
  align-items:center;
  gap:10px;

  /* size */
  max-width:420px;
  width:min(420px, 100vw - 24px);
  max-height:96vh;
}

.shell::before{
  content:"";
  position:absolute;
  inset:-2px;
  border-radius:26px;
  background:
    radial-gradient(circle at 0% 0%,rgba(236,72,153,0.27),transparent 60%),
    radial-gradient(circle at 100% 100%,rgba(56,189,248,0.24),transparent 60%);
  z-index:-1;
  filter:blur(10px);
  opacity:0.9;
  animation:orbGlow 6s ease-in-out infinite alternate;
}

@keyframes orbGlow{
  0%{transform:translate3d(-4px,-4px,0) scale(1);}
  100%{transform:translate3d(4px,4px,0) scale(1.02);}
}

/* TITLE */
h1{
  font-family:'Cinzel',serif;
  font-weight:900;
  letter-spacing:0.12em;
  font-size:1.05rem;
  text-transform:uppercase;
  text-align:center;
  color:#e5e7eb;
  text-shadow:
    0 0 8px rgba(248,250,252,0.9),
    0 0 16px rgba(251,113,133,0.8);
}
h1 span{
  display:block;
  font-size:0.8rem;
  letter-spacing:0.28em;
  color:#a5b4fc;
  text-shadow:none;
  margin-top:2px;
}

/* TOP BUTTONS (help / trophy / pause) */
#helpBtn,#trophyBtn,#pauseBtn{
  position:absolute;
  top:8px;
  width:36px;
  height:36px;
  border-radius:50%;
  border:1px solid var(--gold);
  background:linear-gradient(135deg,var(--pink),var(--aqua));
  display:flex;
  align-items:center;
  justify-content:center;
  font-size:20px;
  cursor:pointer;
  box-shadow:0 0 12px rgba(255,255,255,0.7);
  z-index:15;
}
#helpBtn{left:8px;}
#trophyBtn{right:52px;}
#pauseBtn{right:8px;}

/* HUD */
.hud-row{
  width:100%;
  display:flex;
  justify-content:space-between;
  font-size:0.8rem;
  color:#e5e7eb;
}
.hud-row .label{opacity:0.8;}
.hud-row .value{
  color:var(--gold);
  text-shadow:0 0 6px #ffd166;
}
.hud-row .next{
  color:var(--pink);
  text-shadow:0 0 6px #ff7eb9;
}

/* GAME CANVAS */
#game{
  margin-top:8px;
  border-radius:18px;
  border:1px solid var(--outline);
  background:radial-gradient(circle at top,#020617 0%,#000 50%,#020617 100%);
  box-shadow:
    0 0 22px rgba(59,130,246,0.55),
    0 0 50px rgba(15,23,42,0.9);
  image-rendering:pixelated;
  touch-action:none; /* stop pinch/drag gestures on canvas */
}

/* FLOATING SPARKLES */
.sparkle-overlay{
  pointer-events:none;
  position:absolute;
  inset:0;
  overflow:hidden;
  border-radius:24px;
  mix-blend-mode:screen;
  opacity:0.45;
}
.spark{
  position:absolute;
  width:3px;
  height:3px;
  border-radius:50%;
  background:radial-gradient(circle,#e5e7eb 0%,rgba(244,244,245,0) 70%);
  box-shadow:0 0 8px rgba(255,255,255,0.9);
  animation:floatUp 8s linear infinite;
}
.spark:nth-child(2){animation-duration:10s;}
.spark:nth-child(3){animation-duration:12s;}
.spark:nth-child(4){animation-duration:9s;}
.spark:nth-child(5){animation-duration:11s;}
.spark:nth-child(6){animation-duration:13s;}

@keyframes floatUp{
  0%{transform:translate3d(0,120%,0) scale(0.6); opacity:0;}
  18%{opacity:1;}
  80%{opacity:1;}
  100%{transform:translate3d(0,-40%,0) scale(1.05); opacity:0;}
}

/* MOBILE / TABLET BUTTON PAD */
#mobileControls,
#mobileDownRow{
  display:none;
  width:100%;
  justify-content:center;
  gap:12px;
  margin-top:10px;
}

.mob-btn{
  width:52px;
  height:52px;
  border-radius:50%;
  border:1px solid var(--gold);
  background:linear-gradient(135deg,var(--pink),var(--aqua));
  box-shadow:0 0 12px rgba(255,255,255,0.7);
  font-size:22px;
  color:#111827;
  display:flex;
  align-items:center;
  justify-content:center;
  cursor:pointer;
}

/* Special glowing style for rotate button */
#rotateBtn{
  background:radial-gradient(circle at 30% 20%, #fdf2ff, #e879f9 40%, #a855f7 80%);
  box-shadow:0 0 18px rgba(232,121,249,0.9);
}

/* show pad on mobile + small tablets */
@media(max-width:1366px){
  #mobileControls,
  #mobileDownRow{
    display:flex;
  }
}

/* PAUSE OVERLAY */
#pauseOverlay{
  position:absolute;
  inset:0;
  border-radius:24px;
  background:rgba(0,0,0,0.6);
  display:none;
  align-items:center;
  justify-content:center;
  z-index:25;
  font-size:0.95rem;
  text-shadow:0 0 6px #fff;
}

/* HELP OVERLAY */
#helpOverlay{
  position:absolute;
  inset:0;
  border-radius:24px;
  background:rgba(0,0,15,0.8);
  backdrop-filter:blur(6px);
  display:none;
  align-items:center;
  justify-content:center;
  z-index:30;
}
.help-card{
  width:88%;
  max-width:380px;
  padding:18px 20px 16px;
  border-radius:18px;
  background:radial-gradient(circle,#111827,#020617 60%);
  border:1px solid rgba(255,255,255,0.25);
  position:relative;
  color:#e5e7eb;
  font-size:0.8rem;
}
.help-title{
  font-family:'Cinzel';
  text-align:center;
  font-size:1.1rem;
  margin-bottom:8px;
}
#helpClose{
  position:absolute;
  top:8px;
  right:8px;
  width:26px;
  height:26px;
  border-radius:50%;
  background:linear-gradient(135deg,var(--pink),var(--aqua));
  border:1px solid var(--gold);
  display:flex;
  align-items:center;
  justify-content:center;
  font-size:16px;
  cursor:pointer;
  box-shadow:0 0 8px rgba(255,255,255,0.7);
}

/* LEADERBOARD POPUP */
#leaderboardOverlay{
  position:absolute;
  inset:0;
  border-radius:24px;
  background:rgba(0,0,15,0.9);
  backdrop-filter:blur(6px);
  display:none;
  align-items:center;
  justify-content:center;
  z-index:32;
}
.leader-card{
  width:88%;
  max-width:360px;
  padding:18px 20px 16px;
  border-radius:18px;
  background:radial-gradient(circle,#020617,#020617 60%);
  border:1px solid rgba(255,255,255,0.25);
  color:#e5e7eb;
  position:relative;
  font-size:0.8rem;
}
.leader-title{
  font-family:'Cinzel';
  text-align:center;
  font-size:1.05rem;
  margin-bottom:8px;
}
#leaderClose{
  position:absolute;
  top:8px;
  right:8px;
  width:26px;
  height:26px;
  border-radius:50%;
  background:linear-gradient(135deg,var(--pink),var(--aqua));
  border:1px solid var(--gold);
  display:flex;
  align-items:center;
  justify-content:center;
  font-size:16px;
  cursor:pointer;
  box-shadow:0 0 8px rgba(255,255,255,0.7);
}
#leaderboardList{
  margin-top:4px;
  line-height:1.6;
}

/* QUESTION OVERLAY */
#questionOverlay{
  position:fixed;
  inset:0;
  background:rgba(0,0,20,0.82);
  backdrop-filter:blur(8px);
  display:none;
  align-items:center;
  justify-content:center;
  z-index:50;
}
.q-card{
  width:min(92vw,420px);
  border-radius:20px;
  padding:20px 18px 18px;
  background:radial-gradient(circle at top,#111827,#020617 65%,#020617 100%);
  border:1px solid rgba(248,250,252,0.25);
  box-shadow:
    0 0 30px rgba(251,113,133,0.8),
    0 0 80px rgba(56,189,248,0.6);
  color:#f9fafb;
}
.q-title{
  font-family:'Cinzel',serif;
  font-size:1.05rem;
  text-align:center;
  text-transform:uppercase;
  letter-spacing:0.16em;
  margin-bottom:8px;
  color:#fefce8;
  text-shadow:
    0 0 6px rgba(250,204,21,0.9),
    0 0 14px rgba(250,250,250,0.8);
}

/* START OVERLAY */
#startOverlay{
  position:fixed;
  inset:0;
  background:rgba(0,0,10,0.85);
  display:flex;
  align-items:center;
  justify-content:center;
  z-index:60;
  text-align:center;
}
#startOverlayInner{
  padding:20px 18px;
  border-radius:18px;
  border:1px solid rgba(255,255,255,0.3);
  background:radial-gradient(circle,#111827,#020617 60%);
  box-shadow:0 0 30px rgba(59,130,246,0.8);
  font-size:0.95rem;
}
#startOverlayInner .big{
  display:block;
  font-size:1.1rem;
  margin-bottom:6px;
}
</style>
</head>
<body>

<!-- Tap-to-start fullscreen overlay -->
<div id="startOverlay">
  <div id="startOverlayInner">
    <span class="big">ÁîªÈù¢„Çí„Çø„ÉÉ„Éó„Åó„Å¶„Çπ„Çø„Éº„Éà</span>
    „Éñ„É≠„ÉÉ„ÇØ„ÇíÂãï„Åã„Åó„Å¶„É©„Ç§„É≥„ÇíÊ∂à„Åù„ÅÜÔºÅ<br>
    ÔºëÔºê„É©„Ç§„É≥„Åî„Å®„Å´„Éñ„Éº„Éè„ÇØ„Ç§„Ç∫„ÅåÂá∫„Å¶„Åè„Çã„Çà„ÄÇ
  </div>
</div>

<div class="shell">

  <!-- TITLE -->
  <h1>
    BOOHA TETRIS
    <span>ÔºëÊúà„ÅÆ„Çå„Çì„Åó„ÇÖ„ÅÜ</span>
  </h1>

  <!-- TOP BUTTONS -->
  <div id="helpBtn">Ôºü</div>
  <div id="trophyBtn">üèÜ</div>
  <div id="pauseBtn">‚è∏</div>

  <!-- HUD -->
  <div class="hud-row">
    <div>
      <span class="label">„É©„Ç§„É≥Ôºö</span>
      <span class="value" id="linesCount">0</span>
    </div>
    <div>
      <span class="label">Ê¨°„ÅÆ„ÇØ„Ç§„Ç∫Ôºö</span>
      <span class="next" id="nextAt">10</span>
      <span class="label">„É©„Ç§„É≥</span>
    </div>
  </div>

  <div class="hud-row">
    <div>
      <span class="label">„Çπ„Ç≥„Ç¢Ôºö</span>
      <span class="value" id="scoreValue">0</span>
    </div>
    <div></div>
  </div>

  <!-- GAME CANVAS -->
  <canvas id="game" width="320" height="640"></canvas>

  <!-- SPARKLE OVERLAY -->
  <div class="sparkle-overlay">
    <div class="spark" style="left:10%;"></div>
    <div class="spark" style="left:30%;"></div>
    <div class="spark" style="left:50%;"></div>
    <div class="spark" style="left:70%;"></div>
    <div class="spark" style="left:85%;"></div>
    <div class="spark" style="left:42%;"></div>
  </div>

  <!-- PAUSE OVERLAY -->
  <div id="pauseOverlay">
    <div>„Çø„ÉÉ„Éó„Åó„Å¶„Ç≤„Éº„É†„Å´Êàª„Çã</div>
  </div>

  <!-- HELP OVERLAY -->
  <div id="helpOverlay">
    <div class="help-card">
      <div id="helpClose">‚úï</div>

      <div class="help-title">How to Play Ôºè ÈÅä„Å≥Êñπ</div>

      <div class="help-section">
        <strong>English</strong><br>
        „ÉªTap the rotate button to rotate<br>
        „ÉªUse the ‚Üê ‚Üí buttons to move<br>
        „ÉªUse the ‚Üì button to soft drop<br>
        „ÉªClear lines to score points<br>
        „ÉªEvery 10 lines opens a Booha Question
      </div>

      <div class="help-section">
        <strong>Êó•Êú¨Ë™û</strong><br>
        „ÉªÂõûËª¢„Éú„Çø„É≥„Çí„Çø„ÉÉ„Éó ‚Üí ÂõûËª¢<br>
        „Éª‚Üê ‚Üí „Éú„Çø„É≥ ‚Üí Â∑¶Âè≥„Å´Âãï„Åã„Åô<br>
        „Éª‚Üì „Éú„Çø„É≥ ‚Üí ‰∏ã„Å´ËêΩ„Å®„Åô<br>
        „Éª„É©„Ç§„É≥„ÇíÊ∂à„Åô„Å®„Éù„Ç§„É≥„Éà„ÅåÂÖ•„Çã<br>
        „ÉªÔºëÔºê„É©„Ç§„É≥„Åî„Å®„Å´„Äå„Éñ„Éº„Éè„ÇØ„Ç§„Ç∫„Äç„ÅåÂá∫„Çã
      </div>
    </div>
  </div>

  <!-- LEADERBOARD POPUP -->
  <div id="leaderboardOverlay">
    <div class="leader-card">
      <div id="leaderClose">‚úï</div>
      <div class="leader-title">„É≠„Éº„Ç´„É´„Éª„Éè„Ç§„Çπ„Ç≥„Ç¢</div>
      <div id="leaderboardList">„Åæ„Å†„ÅÇ„Çä„Åæ„Åõ„Çì</div>
    </div>
  </div>

  <!-- MOBILE CONTROL BUTTONS -->
  <div id="mobileControls">
    <div class="mob-btn" id="moveLeftBtn">‚Üê</div>
    <div class="mob-btn" id="rotateBtn">‚Üª</div>
    <div class="mob-btn" id="moveRightBtn">‚Üí</div>
  </div>

  <div id="mobileDownRow">
    <div class="mob-btn" id="moveDownBtn">‚Üì</div>
  </div>

</div> <!-- end shell -->

<!-- QUESTION OVERLAY (GLOBAL) -->
<div id="questionOverlay">
  <div class="q-card">
    <div class="q-title">Checkpoint</div>
    <div class="q-sub">Booha Question Gate</div>
    <div id="questionText"></div>
    <button id="continueBtn">Continue</button>
  </div>
</div>
<script>
// =====================
// AUDIO
// =====================
let gameStarted = false;   // NEW: controls both game + BGM start
let bgmStarted  = false;

const bgm = new Audio("booha-tetris-january.mp3");
bgm.loop = true;
bgm.volume = 0.55;

const sfxClear = new Audio("booha-tetris-sound.mp3");
sfxClear.volume = 0.9;

function ensureBgm(){
  // only allow music once the game has actually started
  if(!gameStarted || bgmStarted) return;
  bgm.play().then(()=>{ bgmStarted = true; }).catch(()=>{});
}

// =====================
// CANVAS & GLOBALS
// =====================
const canvas = document.getElementById("game");
const context = canvas.getContext("2d");
const grid = 32;

let rAF = null;
let gameOver = false;
let isPaused = false;
let isPausedForQuestion = false;

const linesCountEl = document.getElementById("linesCount");
const nextAtEl   = document.getElementById("nextAt");
const scoreEl    = document.getElementById("scoreValue");

let linesClearedTotal = 0;
let currentQuestionIndex = 0;
let score = 0;

// Leaderboard
const leaderboardList = document.getElementById("leaderboardList");
let leaderboardData = [];
const LEADERBOARD_KEY = "boohaTetrisScores";

function loadScores(){
  try{
    const raw = localStorage.getItem(LEADERBOARD_KEY);
    if(raw) leaderboardData = JSON.parse(raw) || [];
  }catch(e){
    leaderboardData = [];
  }
}
function saveScoreToLocal(newScore){
  if(!newScore || isNaN(newScore)) return;
  leaderboardData.push({score:newScore, date:Date.now()});
  leaderboardData.sort((a,b)=>b.score - a.score);
  leaderboardData = leaderboardData.slice(0,5);
  try{
    localStorage.setItem(LEADERBOARD_KEY, JSON.stringify(leaderboardData));
  }catch(e){}
  renderLeaderboard();
}
function renderLeaderboard(){
  if(!leaderboardList) return;
  if(!leaderboardData.length){
    leaderboardList.textContent = "„É≠„Éº„Ç´„É´„Éª„Éè„Ç§„Çπ„Ç≥„Ç¢Ôºö„Åæ„Å†„ÅÇ„Çä„Åæ„Åõ„Çì";
    return;
  }
  let html = "<div>ÊúÄÊñ∞Ôºï„Ç≤„Éº„É†</div><div style='margin-top:4px;'>";
  leaderboardData.forEach((entry,idx)=>{
    html += `<div>${idx+1}‰ΩçÔºö${entry.score} ÁÇπ</div>`;
  });
  html += "</div>";
  leaderboardList.innerHTML = html;
}

// Questions (placeholders)
const questions = Array.from({length:60}, (_,i)=>
  `Question ${i+1} placeholder ‚Äî January vocab EN/JP here.`
);

// =====================
// PLAYFIELD
// =====================
const playfield = [];
for(let row=-2; row<20; row++){
  playfield[row] = [];
  for(let col=0; col<10; col++){
    playfield[row][col] = 0;
  }
}

// =====================
// TETROMINOS
// =====================
const tetrominos = {
  "I":[[0,0,0,0],[1,1,1,1],[0,0,0,0],[0,0,0,0]],
  "J":[[1,0,0],[1,1,1],[0,0,0]],
  "L":[[0,0,1],[1,1,1],[0,0,0]],
  "O":[[1,1],[1,1]],
  "S":[[0,1,1],[1,1,0],[0,0,0]],
  "Z":[[1,1,0],[0,1,1],[0,0,0]],
  "T":[[0,1,0],[1,1,1],[0,0,0]]
};
const colors = {
  "I":"#7dd3fc",
  "O":"#facc15",
  "T":"#e879f9",
  "S":"#4ade80",
  "Z":"#fb7185",
  "J":"#a855f7",
  "L":"#f97316"
};

// =====================
// SEQUENCE
// =====================
const tetrominoSequence = [];
function getRandomInt(min,max){
  return Math.floor(Math.random()*(max-min+1))+min;
}
function generateSequence(){
  const seq = ['I','J','L','O','S','T','Z'];
  while(seq.length){
    const idx = getRandomInt(0, seq.length-1);
    tetrominoSequence.push(seq.splice(idx,1)[0]);
  }
}
function getNextTetromino(){
  if(!tetrominoSequence.length) generateSequence();
  const name = tetrominoSequence.pop();
  const matrix = tetrominos[name];
  const col = playfield[0].length/2 - Math.ceil(matrix[0].length/2);
  const row = name === "I" ? -1 : -2;
  return {name,matrix,row,col};
}
let tetromino = getNextTetromino();

// =====================
// ROTATE & COLLISION
// =====================
function rotate(matrix){
  const N = matrix.length - 1;
  return matrix.map((row,i)=>
    row.map((val,j)=>matrix[N-j][i])
  );
}
function isValidMove(matrix, cellRow, cellCol){
  for(let r=0; r<matrix.length; r++){
    for(let c=0; c<matrix[r].length; c++){
      if(matrix[r][c]){
        if(
          cellCol + c < 0 ||
          cellCol + c >= playfield[0].length ||
          cellRow + r >= playfield.length ||
          playfield[cellRow+r][cellCol+c]
        ){
          return false;
        }
      }
    }
  }
  return true;
}

// =====================
// PARTICLES
// =====================
const particles = [];
function createSparklesForRow(rowIndex){
  const y = rowIndex*grid + grid/2;
  for(let col=0; col<10; col++){
    const x = col*grid + grid/2;
    for(let i=0; i<6; i++){
      const angle = Math.random()*Math.PI*2;
      const speed = Math.random()*2 + 0.5;
      particles.push({
        x,y,
        vx:Math.cos(angle)*speed,
        vy:Math.sin(angle)*speed - 0.5,
        life:30+Math.random()*20,
        alpha:1
      });
    }
  }
}
function updateParticles(){
  for(let i=particles.length-1; i>=0; i--){
    const p = particles[i];
    p.x += p.vx;
    p.y += p.vy;
    p.vy += 0.04;
    p.life -= 1;
    p.alpha -= 0.03;
    if(p.life<=0 || p.alpha<=0){
      particles.splice(i,1);
      continue;
    }
    context.save();
    context.globalAlpha = p.alpha;
    context.fillStyle = "#ffeaa7";
    context.fillRect(p.x-2,p.y-2,4,4);
    context.restore();
  }
}

// =====================
// HUD & QUESTIONS & SCORE
// =====================
function updateHud(){
  linesCountEl.textContent = linesClearedTotal;
  nextAtEl.textContent = (currentQuestionIndex+1)*10;
  scoreEl.textContent = score;
}

const questionOverlay = document.getElementById("questionOverlay");
const questionTextEl  = document.getElementById("questionText");
const continueBtn     = document.getElementById("continueBtn");

function maybeTriggerQuestion(){
  const threshold = (currentQuestionIndex+1)*10;
  if(linesClearedTotal >= threshold){
    showQuestion();
  }
}
function showQuestion(){
  isPausedForQuestion = true;
  questionTextEl.textContent = questions[currentQuestionIndex] || "Question placeholder.";
  questionOverlay.style.display = "flex";
}
continueBtn.onclick = ()=>{
  currentQuestionIndex = Math.min(currentQuestionIndex+1, questions.length);
  questionOverlay.style.display = "none";
  isPausedForQuestion = false;
  updateHud();
};

// scoring per lines
// 1 line = 10, 2 lines = 20, 3 lines = 50, 4 lines = 100
const lineScoreTable = [0,10,20,50,100];

// =====================
// PLACE TETROMINO
// =====================
function placeTetromino(){
  for(let r=0; r<tetromino.matrix.length; r++){
    for(let c=0; c<tetromino.matrix[r].length; c++){
      if(tetromino.matrix[r][c]){
        if(tetromino.row+r < 0){
          showGameOver();
          return;
        }
        playfield[tetromino.row+r][tetromino.col+c] = tetromino.name;
      }
    }
  }

  let cleared = 0;

  for(let r=playfield.length-1; r>=0; ){
    if(playfield[r].every(v=>!!v)){
      createSparklesForRow(r);
      cleared++;
      sfxClear.currentTime = 0;
      sfxClear.play();

      for(let rr=r; rr>=0; rr--){
        for(let cc=0; cc<10; cc++){
          playfield[rr][cc] = playfield[rr-1]?.[cc] || 0;
        }
      }
    }else{
      r--;
    }
  }

  if(cleared>0){
    linesClearedTotal += cleared;
    score += lineScoreTable[cleared] || cleared*10;
    updateHud();
    maybeTriggerQuestion();
  }

  tetromino = getNextTetromino();
}

// =====================
// GAME LOOP
// =====================
let frameCount = 0;
function loop(){
  rAF = requestAnimationFrame(loop);
  if(isPaused || isPausedForQuestion || gameOver || !gameStarted) return;

  context.clearRect(0,0,canvas.width,canvas.height);

  for(let r=0; r<20; r++){
    for(let c=0; c<10; c++){
      const cell = playfield[r][c];
      context.fillStyle = cell ? colors[cell] : "rgba(15,23,42,0.5)";
      context.fillRect(c*grid,r*grid,grid-1,grid-1);
    }
  }

  updateParticles();

  if(++frameCount > 35){
    tetromino.row++;
    frameCount = 0;
    if(!isValidMove(tetromino.matrix, tetromino.row, tetromino.col)){
      tetromino.row--;
      placeTetromino();
    }
  }

  context.fillStyle = colors[tetromino.name];
  for(let r=0; r<tetromino.matrix.length; r++){
    for(let c=0; c<tetromino.matrix[r].length; c++){
      if(tetromino.matrix[r][c]){
        context.fillRect(
          (tetromino.col+c)*grid,
          (tetromino.row+r)*grid,
          grid-1,grid-1
        );
      }
    }
  }
}

// =====================
// MOVEMENT FUNCTIONS
// =====================
function moveLeft(){
  if(!gameStarted || gameOver || isPaused || isPausedForQuestion) return;
  const nc = tetromino.col - 1;
  if(isValidMove(tetromino.matrix,tetromino.row,nc)) tetromino.col = nc;
}
function moveRight(){
  if(!gameStarted || gameOver || isPaused || isPausedForQuestion) return;
  const nc = tetromino.col + 1;
  if(isValidMove(tetromino.matrix,tetromino.row,nc)) tetromino.col = nc;
}
function rotatePiece(){
  if(!gameStarted || gameOver || isPaused || isPausedForQuestion) return;
  const rot = rotate(tetromino.matrix);
  if(isValidMove(rot,tetromino.row,tetromino.col)) tetromino.matrix = rot;
}
function softDrop(){
  if(!gameStarted || gameOver || isPaused || isPausedForQuestion) return;
  const nr = tetromino.row + 1;
  if(isValidMove(tetromino.matrix,nr,tetromino.col)){
    tetromino.row = nr;
  }else{
    placeTetromino();
  }
}

// =====================
// KEYBOARD (DESKTOP)
// =====================
document.addEventListener("keydown", e=>{
  if(!gameStarted) return;
  if(gameOver || isPaused || isPausedForQuestion) return;

  if(e.key==="ArrowLeft")  moveLeft();
  if(e.key==="ArrowRight") moveRight();
  if(e.key==="ArrowUp")    rotatePiece();
  if(e.key==="ArrowDown")  softDrop();
});

// =====================
// MOBILE / TABLET CONTROL BUTTONS
// =====================
const moveLeftBtn  = document.getElementById("moveLeftBtn");
const moveRightBtn = document.getElementById("moveRightBtn");
const rotateBtn    = document.getElementById("rotateBtn");
const moveDownBtn  = document.getElementById("moveDownBtn");

function attachControl(btn, handler){
  if(!btn) return;
  btn.addEventListener("click", ()=>{
    if(!gameStarted) return;
    handler();
  });
  btn.addEventListener("touchstart", (e)=>{
    e.preventDefault();
    if(!gameStarted) return;
    handler();
  }, {passive:false});
}

attachControl(moveLeftBtn,  moveLeft);
attachControl(moveRightBtn, moveRight);
attachControl(rotateBtn,    rotatePiece);
attachControl(moveDownBtn,  softDrop);

// =====================
// PAUSE
// =====================
const pauseBtn     = document.getElementById("pauseBtn");
const pauseOverlay = document.getElementById("pauseOverlay");

function pauseGame(){
  if(!gameStarted || gameOver) return;
  isPaused = true;
  pauseOverlay.style.display = "flex";
  if(bgmStarted) bgm.volume = 0.25;
}
function resumeGame(){
  if(!gameStarted) return;
  isPaused = false;
  pauseOverlay.style.display = "none";
  if(bgmStarted) bgm.volume = 0.55;
}

pauseBtn.onclick = ()=>{
  if(!gameStarted) return;
  if(isPaused) resumeGame(); else pauseGame();
};
pauseOverlay.onclick = resumeGame;

// =====================
// HELP
// =====================
const helpBtn      = document.getElementById("helpBtn");
const helpOverlay  = document.getElementById("helpOverlay");
const helpClose    = document.getElementById("helpClose");

helpBtn.onclick = ()=>{
  if(!gameStarted || gameOver) return;
  pauseGame();
  helpOverlay.style.display = "flex";
};
helpClose.onclick = ()=>{
  helpOverlay.style.display = "none";
  resumeGame();
};

// =====================
// LEADERBOARD POPUP
// =====================
const trophyBtn         = document.getElementById("trophyBtn");
const leaderboardOverlay = document.getElementById("leaderboardOverlay");
const leaderClose       = document.getElementById("leaderClose");

function openLeaderboard(){
  if(!gameStarted) return;
  pauseGame();
  renderLeaderboard();
  leaderboardOverlay.style.display = "flex";
}
function closeLeaderboard(){
  leaderboardOverlay.style.display = "none";
  resumeGame();
}

if(trophyBtn){
  trophyBtn.addEventListener("click", openLeaderboard);
  trophyBtn.addEventListener("touchstart", function(e){
    e.preventDefault();
    openLeaderboard();
  }, {passive:false});
}
if(leaderClose){
  leaderClose.addEventListener("click", closeLeaderboard);
  leaderClose.addEventListener("touchstart", function(e){
    e.preventDefault();
    closeLeaderboard();
  }, {passive:false});
}

// =====================
// GAME OVER
// =====================
function showGameOver(){
  if(gameOver) return;
  gameOver = true;
  cancelAnimationFrame(rAF);
  saveScoreToLocal(score);

  context.fillStyle = "rgba(0,0,0,0.7)";
  context.fillRect(0,canvas.height/2-40,canvas.width,80);

  context.fillStyle = "#fff";
  context.font = "28px Cinzel";
  context.textAlign = "center";
  context.fillText("GAME OVER",canvas.width/2,canvas.height/2);
}

// =====================
// INIT + TAP-TO-START
// =====================
loadScores();
renderLeaderboard();
updateHud();

const startOverlay = document.getElementById("startOverlay");

function startGame(){
  if(gameStarted) return;
  gameStarted = true;
  startOverlay.style.display = "none";
  ensureBgm();
  rAF = requestAnimationFrame(loop);
}

startOverlay.addEventListener("click", startGame);
startOverlay.addEventListener("touchstart", function(e){
  e.preventDefault();
  startGame();
},{passive:false});
</script>
