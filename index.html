<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Booha Tetris – January Vocab</title>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@700;900&family=Noto+Sans+JP:wght@500;700&display=swap" rel="stylesheet">

<style>
:root{
  --pink:#ff7eb9;
  --aqua:#7dd3fc;
  --gold:#ffd166;
  --dark:#020617;
  --glow:0 0 14px rgba(255,255,255,0.9), 0 0 28px rgba(255,255,255,0.5);
}

*{box-sizing:border-box;margin:0;padding:0;}
html,body{
  width:100%;height:100%;overflow:hidden;
  background:#000;
  font-family:'Noto Sans JP', sans-serif;
  color:#fff;
}

.wrapper{
  position:relative;
  width:100%;
  height:100%;
  display:flex;
  flex-direction:column;
  align-items:center;
  justify-content:flex-start;
  padding-top:10px;
}

/* Pulsating Glow Background */
.bg-glow{
  position:absolute;
  inset:0;
  background:
    radial-gradient(circle at 50% 30%, rgba(255,255,255,0.12), transparent 70%),
    radial-gradient(circle at 20% 80%, rgba(255,128,192,0.15), transparent 65%),
    radial-gradient(circle at 80% 20%, rgba(128,200,255,0.15), transparent 70%);
  animation:pulse 6s ease-in-out infinite alternate;
  z-index:-2;
}
@keyframes pulse{
  0%{transform:scale(1);}
  100%{transform:scale(1.05);}
}

h1{
  font-family:'Cinzel',serif;
  font-weight:900;
  text-align:center;
  text-transform:uppercase;
  letter-spacing:0.1em;
  color:#fff;
  text-shadow:var(--glow);
  font-size:1.3rem;
}

.sub{
  font-size:0.85rem;
  text-align:center;
  letter-spacing:0.12em;
  margin-bottom:10px;
  color:#a5b4fc;
}

.hud{
  width:92%;
  display:flex;
  justify-content:space-between;
  margin-bottom:6px;
  font-size:0.85rem;
}

.hud .count{
  color:var(--gold);
  text-shadow:0 0 6px rgba(255,225,100,0.9);
}

.hud .nextq{
  color:var(--pink);
  text-shadow:0 0 6px rgba(255,120,160,0.9);
}

/* Canvas */
#game{
  border-radius:20px;
  background:#020617;
  border:1px solid rgba(255,255,255,0.28);
  box-shadow:
    0 0 20px rgba(125,195,250,0.4),
    0 0 40px rgba(255,128,190,0.3);
}

/* Pause Button */
#pauseBtn{
  position:absolute;
  top:10px;right:10px;
  width:38px;height:38px;
  border-radius:50%;
  background:linear-gradient(135deg,var(--aqua),var(--pink));
  border:1px solid var(--gold);
  box-shadow:0 0 12px rgba(255,255,255,0.6);
  display:flex;
  align-items:center;
  justify-content:center;
  font-size:20px;
  cursor:pointer;
  z-index:20;
  animation:bob 3s ease-in-out infinite;
}
@keyframes bob{
  0%{transform:translateY(0);}
  50%{transform:translateY(-3px);}
  100%{transform:translateY(0);}
}

/* Pause Overlay */
#pauseOverlay{
  position:fixed;
  inset:0;
  background:rgba(0,0,20,0.7);
  backdrop-filter:blur(8px);
  display:none;
  align-items:center;
  justify-content:center;
  z-index:50;
  text-align:center;
  font-size:1.2rem;
  color:#fff;
}

#pauseOverlay div{
  text-shadow:var(--glow);
  font-family:'Cinzel',serif;
  letter-spacing:0.1em;
}

/* Question Overlay */
#questionOverlay{
  position:fixed;
  inset:0;
  display:none;
  background:rgba(0,0,20,0.8);
  backdrop-filter:blur(8px);
  z-index:60;
  align-items:center;
  justify-content:center;
}

.q-box{
  width:90%;
  max-width:380px;
  background:radial-gradient(circle at top,#111827,#020617 70%);
  border-radius:20px;
  border:1px solid rgba(255,255,255,0.25);
  padding:18px;
  text-align:center;
  box-shadow:
    0 0 30px rgba(255,120,160,0.6),
    0 0 40px rgba(125,200,255,0.4);
}

.q-box h2{
  font-family:'Cinzel',serif;
  font-size:1.1rem;
  text-transform:uppercase;
  margin-bottom:10px;
  letter-spacing:0.12em;
}

#continueBtn{
  width:100%;
  padding:10px;
  border-radius:999px;
  background:linear-gradient(125deg,#f97316,#fb7185,#e879f9);
  border:none;
  font-weight:700;
  letter-spacing:0.1em;
  cursor:pointer;
  margin-top:14px;
}

.sparkle{
  position:absolute;
  width:4px;height:4px;
  background:#fff;
  border-radius:50%;
  opacity:0.9;
}

</style>
</head>
<body>

<div class="bg-glow"></div>

<div class="wrapper">

  <div id="pauseBtn">⏸</div>

  <h1>Booha Tetris</h1>
  <div class="sub">January Vocab ／ １月の単語</div>

  <div class="hud">
    <div>ライン数：<span id="lineCount" class="count">0</span></div>
    <div>次のクイズ：<span id="nextQ" class="nextq">10</span> ライン目</div>
  </div>

  <canvas id="game" width="320" height="640"></canvas>

</div>

<!-- Pause Screen -->
<div id="pauseOverlay">
  <div>PAUSED ／ 一時停止中<br><br>▶ をタップして続ける</div>
</div>

<!-- Question Overlay -->
<div id="questionOverlay">
  <div class="q-box">
    <h2>Checkpoint</h2>
    <div id="qtext">Question placeholder...</div>
    <button id="continueBtn">Continue</button>
  </div>
</div>

<script>
/* ============================================================
   AUDIO SETUP
   ============================================================ */

const bgm = new Audio("booha-tetris-january.mp3");
bgm.loop = true;
bgm.volume = 0.55;

const clearSFX = new Audio("booha-tetris-sound.mp3");
clearSFX.volume = 0.9;


/* ============================================================
   BASIC TETRIS ENGINE (same as your previous version, modified)
   ============================================================ */

function getRandomInt(min, max){
  min = Math.ceil(min);
  max = Math.floor(max);
  return Math.floor(Math.random()*(max-min+1))+min;
}

const tetrominoSequence=[];
function generateSequence(){
  const seq=['I','J','L','O','S','T','Z'];
  while(seq.length){
    const r=getRandomInt(0,seq.length-1);
    tetrominoSequence.push(seq.splice(r,1)[0]);
  }
}

function getNextTetromino(){
  if(tetrominoSequence.length===0) generateSequence();
  const name=tetrominoSequence.pop();
  const matrix=tetrominos[name];
  const col=playfield[0].length/2 - Math.ceil(matrix[0].length/2);
  const row=name==='I'?-1:-2;
  return {name,matrix,row,col};
}

function rotate(matrix){
  const N=matrix.length-1;
  return matrix.map((row,i)=>
    row.map((val,j)=>matrix[N-j][i])
  );
}

function isValidMove(matrix,cellRow,cellCol){
  for(let r=0;r<matrix.length;r++){
    for(let c=0;c<matrix[r].length;c++){
      if(matrix[r][c] && (
        cellCol+c<0 ||
        cellCol+c>=playfield[0].length ||
        cellRow+r>=playfield.length ||
        playfield[cellRow+r][cellCol+c]
      )){
        return false;
      }
    }
  }
  return true;
}

/* ============================================================
   PLAYFIELD + TETROMINOS
   ============================================================ */

const canvas=document.getElementById("game");
const ctx=canvas.getContext("2d");
const grid=32;

const playfield=[];
for(let r=-2;r<20;r++){
  playfield[r]=[];
  for(let c=0;c<10;c++){
    playfield[r][c]=0;
  }
}

const tetrominos={
  'I':[[0,0,0,0],[1,1,1,1],[0,0,0,0],[0,0,0,0]],
  'J':[[1,0,0],[1,1,1],[0,0,0]],
  'L':[[0,0,1],[1,1,1],[0,0,0]],
  'O':[[1,1],[1,1]],
  'S':[[0,1,1],[1,1,0],[0,0,0]],
  'Z':[[1,1,0],[0,1,1],[0,0,0]],
  'T':[[0,1,0],[1,1,1],[0,0,0]]
};

const colors={
  'I':'#7dd3fc','O':'#facc15','T':'#e879f9','S':'#4ade80',
  'Z':'#fb7185','J':'#a855f7','L':'#f97316'
};

let tetromino=getNextTetromino();
let count=0;
let gameOver=false;
let paused=false;
let isQuestion=false;

let linesCleared=0;
let nextThreshold=10;

const lineCountEl=document.getElementById("lineCount");
const nextQEl=document.getElementById("nextQ");

function placeTetromino(){
  for(let r=0;r<tetromino.matrix.length;r++){
    for(let c=0;c<tetromino.matrix[r].length;c++){
      if(tetromino.matrix[r][c]){
        if(tetromino.row+r<0){
          showGameOver();
          return;
        }
        playfield[tetromino.row+r][tetromino.col+c]=tetromino.name;
      }
    }
  }

  let cleared=0;
  for(let r=19;r>=0;){
    if(playfield[r].every(cell=>!!cell)){
      cleared++;
      clearLine(r);
      for(let rr=r;rr>=0;rr--){
        for(let cc=0;cc<10;cc++){
          playfield[rr][cc]=playfield[rr-1]?.[cc] || 0;
        }
      }
    }else r--;
  }

  if(cleared>0){
    linesCleared+=cleared;
    lineCountEl.textContent=linesCleared;
    clearSFX.currentTime=0;
    clearSFX.play();

    glitterBurst();

    if(linesCleared>=nextThreshold){
      triggerQuestion();
      nextThreshold+=10;
      nextQEl.textContent=nextThreshold;
    }
  }

  tetromino=getNextTetromino();
}

/* ============================================================
   Glitter Burst Animation
   ============================================================ */
const particles=[];

function glitterBurst(){
  for(let i=0;i<50;i++){
    particles.push({
      x:160,y:320,
      vx:(Math.random()-0.5)*6,
      vy:(Math.random()-0.5)*6,
      life:30+Math.random()*20,
      alpha:1
    });
  }
}

function updateParticles(){
  for(let i=particles.length-1;i>=0;i--){
    const p=particles[i];
    p.x+=p.vx;
    p.y+=p.vy;
    p.vy+=0.1;
    p.life--;
    p.alpha-=0.02;
    if(p.life<=0 || p.alpha<=0){
      particles.splice(i,1);
      continue;
    }
    ctx.save();
    ctx.globalAlpha=p.alpha;
    ctx.fillStyle="#fff";
    ctx.fillRect(p.x,p.y,4,4);
    ctx.restore();
  }
}

/* ============================================================
   Question Checkpoint System
   ============================================================ */

const questionOverlay=document.getElementById("questionOverlay");
const qtext=document.getElementById("qtext");
const continueBtn=document.getElementById("continueBtn");

function triggerQuestion(){
  paused=true;
  isQuestion=true;
  questionOverlay.style.display="flex";
  qtext.textContent="Placeholder Question — January Vocab";
  bgm.volume=0.3;
}

continueBtn.onclick=()=>{
  isQuestion=false;
  paused=false;
  questionOverlay.style.display="none";
  bgm.volume=0.55;
};

/* ============================================================
   Game Over
   ============================================================ */

function showGameOver(){
  gameOver=true;
  paused=true;

  ctx.fillStyle="rgba(0,0,0,0.6)";
  ctx.fillRect(0,canvas.height/2-40,canvas.width,80);

  ctx.fillStyle="#fff";
  ctx.font="28px Cinzel";
  ctx.textAlign="center";
  ctx.fillText("GAME OVER",canvas.width/2,canvas.height/2);

  bgm.volume=0.2;
}

/* ============================================================
   Pause Button
   ============================================================ */
const pauseBtn=document.getElementById("pauseBtn");
const pauseOverlay=document.getElementById("pauseOverlay");

pauseBtn.onclick=()=>{
  if(paused){
    paused=false;
    pauseOverlay.style.display="none";
    pauseBtn.textContent="⏸";
    bgm.volume=0.55;
  }else{
    paused=true;
    pauseOverlay.style.display="flex";
    pauseBtn.textContent="▶";
    bgm.volume=0.35;
  }
};

/* ============================================================
   Mobile Touch Controls
   ============================================================ */

let touchStartX=0;
let touchStartY=0;

canvas.addEventListener("touchstart",e=>{
  const t=e.touches[0];
  touchStartX=t.clientX;
  touchStartY=t.clientY;

  // Start BGM on first touch (iOS requirement)
  if(bgm.paused){ bgm.play(); }
});

canvas.addEventListener("touchmove",e=>{
  if(paused || gameOver) return;

  const t=e.touches[0];
  const dx=t.clientX - touchStartX;
  const dy=t.clientY - touchStartY;

  // Horizontal drag → move
  if(Math.abs(dx)>20){
    const dir = dx>0?1:-1;
    const col = tetromino.col + dir;
    if(isValidMove(tetromino.matrix,tetromino.row,col)){
      tetromino.col=col;
      touchStartX=t.clientX;
    }
  }

  // Vertical swipe
  if(dy<-40){ // swipe up
    const rot = rotate(tetromino.matrix);
    if(isValidMove(rot,tetromino.row,tetromino.col)){
      tetromino.matrix=rot;
      touchStartY=t.clientY;
    }
  }

  if(dy>40){ // swipe down
    const r=tetromino.row+1;
    if(!isValidMove(tetromino.matrix,r,tetromino.col)){
      tetromino.row=r-1;
      placeTetromino();
      return;
    }
    tetromino.row=r;
    touchStartY=t.clientY;
  }
});

/* ============================================================
   Keyboard Controls (desktop)
   ============================================================ */
document.addEventListener("keydown",e=>{
  if(gameOver||paused||isQuestion) return;

  if(e.key==="ArrowLeft"){
    const c=tetromino.col-1;
    if(isValidMove(tetromino.matrix,tetromino.row,c))
      tetromino.col=c;
  }
  if(e.key==="ArrowRight"){
    const c=tetromino.col+1;
    if(isValidMove(tetromino.matrix,tetromino.row,c))
      tetromino.col=c;
  }
  if(e.key==="ArrowUp"){
    const rot=rotate(tetromino.matrix);
    if(isValidMove(rot,tetromino.row,tetromino.col))
      tetromino.matrix=rot;
  }
  if(e.key==="ArrowDown"){
    const r=tetromino.row+1;
    if(!isValidMove(tetromino.matrix,r,tetromino.col)){
      tetromino.row=r-1;
      placeTetromino();
      return;
    }
    tetromino.row=r;
  }

  if(bgm.paused) bgm.play();
});

/* ============================================================
   MAIN GAME LOOP
   ============================================================ */

function loop(){
  requestAnimationFrame(loop);
  ctx.clearRect(0,0,canvas.width,canvas.height);

  if(gameOver || paused) return;

  // Draw playfield
  for(let r=0;r<20;r++){
    for(let c=0;c<10;c++){
      if(playfield[r][c]){
        ctx.fillStyle=colors[playfield[r][c]];
        ctx.fillRect(c*grid,r*grid,grid-1,grid-1);
      }else{
        ctx.fillStyle="rgba(255,255,255,0.06)";
        ctx.fillRect(c*grid,r*grid,grid-1,grid-1);
      }
    }
  }

  // Particles
  updateParticles();

  // Tetromino falling
  if(++count>35){
    const r=tetromino.row+1;
    count=0;
    if(!isValidMove(tetromino.matrix,r,tetromino.col)){
      tetromino.row=r-1;
      placeTetromino();
    }else tetromino.row=r;
  }

  // Draw tetromino
  ctx.fillStyle=colors[tetromino.name];
  for(let r=0;r<tetromino.matrix.length;r++){
    for(let c=0;c<tetromino.matrix[r].length;c++){
      if(tetromino.matrix[r][c]){
        ctx.fillRect((tetromino.col+c)*grid,(tetromino.row+r)*grid,grid-1,grid-1);
      }
    }
  }
}

loop();
</script>

</body>
</html>
